<!doctype html>
<html>
	<head>
		<title>Race Test</title>
		<style>
			body, html {
				margin: 0;
				padding: 0;
				background: #333;
				color: #ddd;
				font-family: sans-serif;
				font-weight: bold;
			}
			canvas {
				display: block;
			}
			#help {
				position: absolute;
				left: 8px;
				top: 8px;
				background: rgba(0,0,0,0.3);
				text-shadow: 0 2px 0 #000;
				list-style: none;
				padding: 8px;
				margin: 8px;
			}
		</style>
		<script src="http://cdnjs.cloudflare.com/ajax/libs/three.js/r50/three.min.js"></script>
		<script src="js/gamepad.js"></script>
		<script src="test.js"></script>
		<script type="x-shader/x-vertex" id="shader_vert">

			varying vec2 vUv;

			void main() {

				vUv = uv;
				gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1);

			}

		</script>
		<script type="x-shader/x-fragment" id="shader_frag">

			uniform sampler2D tDiffuse;
			uniform sampler2D tLuminance;
			uniform sampler2D tAO;
			uniform float fHeat;
			uniform int rPass;

			varying vec2 vUv;

			void main() {

				vec3 col = texture2D(tDiffuse, vUv).rgb;
				vec3 ao = texture2D(tAO, vUv).rgb;
				vec3 lum = texture2D(tLuminance, vUv).rgb;

				if (rPass == 0) {
					gl_FragColor = vec4(max(col*ao,lum*fHeat), 1.0);
				} else if (rPass == 1) {
					gl_FragColor = vec4(lum*fHeat, 1.0);
				} else {
					gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);
				}

			}

		</script>
		<script type="x-shader/x-fragment" id="shader_frag_trail">

			uniform sampler2D tNoise;
			uniform float fHeat;
			uniform float fTime;

			varying vec2 vUv;

			void main() {

				vec2 nuv = vUv;
				nuv.x = vUv.x - fTime;
				if (nuv.x <= 0.0) {
					nuv.x = nuv.x + 1.0;
				}

				vec3 noise = vec3(0.0, 0.0, 0.0);
				for (int i = 0; i < 15; i++) {
					noise += texture2D(tNoise, nuv).rgb * 0.1;
					nuv.x += fHeat * fHeat * 0.001;
					if (nuv.x >= 1.0) nuv.x -= 1.0;
				}

				gl_FragColor = vec4(fHeat * 0.2 + 0.1, fHeat * 0.8 + 0.24, fHeat + 0.3, (1.0 - vUv.x * 1.5) * noise * fHeat);
				//gl_FragColor = vec4(1.0 - vUv.x * 1.5, 0.0, 0.0, 1.0);

			}

		</script>
	</head>
	<body>
		<ul id="help">
			<li>WASD/Arrows/Gamepad to control.</li>
			<li id="padstate">Player 1 Press Start</li>
			<li id="padcontrols"></li>
		</ul>
	</body>
</html>